<style>
  #discipleship-impact {
    background: #1e1e1e;
    color: #f5f2eb;
    font-family: "Segoe UI", system-ui, sans-serif;
    padding: 60px 20px;
    text-align: center;
  }

  #discipleship-impact h1 {
    font-weight: 400;
    letter-spacing: 0.05em;
    margin-bottom: 40px;
    color: #ffffff;
  }

  #discipleship-impact .metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 40px;
    max-width: 900px;
    margin: 0 auto;
  }

  #discipleship-impact .circle {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    border: 3px solid #cbb68d;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.02);
    box-shadow: 0 0 30px rgba(0,0,0,0.4);
  }

  #discipleship-impact .value {
    font-size: 4rem;
    font-weight: 600;
    margin-bottom: 18px;
  }

  #discipleship-impact .label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.85;
    text-align: center;
    line-height: 1.4;
  }

  #discipleship-impact footer {
    margin-top: 40px;
    font-size: 0.75rem;
    opacity: 0.5;
  }
</style>

<div id="discipleship-impact">
  <h1>EveryONE Counts Counter</h1>

  <div class="metrics" id="metrics"></div>

  <footer id="last-updated">Last updated: â€”</footer>
</div>

<script>
  const BASE_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPWno5RceeKjky3GWxluBEigdbePn411EyU6GM9KblkVpBZDEvaNntbLo95s1C6ehNOD24PrpZxlBa/pub?gid=901964678&single=true&output=csv";

  async function loadMetrics() {
    try {
      // Cache-busting parameter to defeat Squarespace/Cloudflare caching
      const cacheBustedUrl = BASE_CSV_URL + "&t=" + Date.now();

      const res = await fetch(cacheBustedUrl, { cache: "no-store" });
      const text = await res.text();

      const rows = text.trim().split("\n").slice(1);
      const container = document.getElementById("metrics");
      container.innerHTML = "";

      rows.forEach(row => {
        const [metric, count] = row.split(",");
        if (!metric || !count) return;

        const circle = document.createElement("div");
        circle.className = "circle";
        circle.innerHTML = `
          <div class="value">${count.trim()}</div>
          <div class="label">${metric.trim()}</div>
        `;

        container.appendChild(circle);
      });

      // Update "Last updated" timestamp
      const now = new Date();
      document.getElementById("last-updated").textContent =
        "Last updated: " + now.toLocaleTimeString();

    } catch (err) {
      console.error("Failed to load CSV", err);
    }
  }

  // Initial load
  loadMetrics();

  // Refresh every 15 seconds
  setInterval(loadMetrics, 15000);
</script>
